{% extends "portal/portal_base.html" %}
{% load static %}
{% load bootstrap5 %}

{% block portal_title %}{{ book.title }}{% endblock %}

{% block portal_content %}
<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'books:portal_catalog' %}">Catalog</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ book.title|truncatechars:50 }}</li>
        </ol>
    </nav>

    <div class="row g-5">
        <div class="col-md-4">
            {% if book.cover_image_url %}
                <img src="{{ book.cover_image_url }}" class="img-fluid rounded shadow-sm mb-3" alt="{{ book.title }} cover" style="max-height: 500px; width: 100%; object-fit: cover;">
            {% else %}
                <div class="bg-light border rounded d-flex align-items-center justify-content-center text-muted mb-3" style="height: 400px; border-style: dashed!important;">
                    <i class="bi bi-image-alt h1"></i><br/>
                    <small>No Cover Available</small>
                </div>
            {% endif %}
            
            {% if user.is_authenticated %}
                {# Borrow/Reserve Button Logic #}
                {% if has_active_or_pending_request %}
                    <button class="btn btn-secondary w-100 mb-2" disabled>
                        <i class="bi bi-clock-history"></i> Request Pending / Loan Active
                    </button>
                {% elif book.available_copies_count > 0 %}
                    <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#borrowBookModal">
                        <i class="bi bi-book-half"></i> Request to Borrow
                    </button>
                {% else %}
                     {# Assuming you'll have a reservation system #}
                    <form method="post" action="{% url 'books:portal_book_reserve' isbn=book.isbn %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning w-100 mb-2">
                            <i class="bi bi-bookmark-plus"></i> Request Reservation
                        </button>
                    </form>
                {% endif %}
            {% else %}
                 <a href="{% url 'users:login' %}?next={{ request.path }}" class="btn btn-outline-primary w-100 mb-2">Login to Borrow or Reserve</a>
            {% endif %}
            {# Add to favorites if you implement this feature #}
        </div>

        <div class="col-md-8">
            <h1 class="display-5 mb-1">{{ book.title }}</h1>
            {% if book.authors.all %}
                <p class="lead text-muted mb-3">
                    By 
                    {% for author in book.authors.all %}
                        {{ author.name }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
            {% endif %}

            <div class="mb-3">
                {% for cat in book.categories.all %}
                    <span class="badge bg-info text-dark me-1">{{ cat.name }}</span>
                {% endfor %}
            </div>
            
            <p class="mb-2"><strong>ISBN-13:</strong> {{ book.isbn }}</p>
            {% if book.publisher %}
                <p class="mb-2"><strong>Publisher:</strong> {{ book.publisher }}{% if book.publication_date %}, {{ book.publication_date|date:"Y" }}{% endif %}</p>
            {% endif %}
            {% if book.edition %}<p class="mb-2"><strong>Edition:</strong> {{ book.edition }}</p>{% endif %}
            {% if book.page_count %}<p class="mb-2"><strong>Pages:</strong> {{ book.page_count }}</p>{% endif %}
            
            <h5 class="mt-4">Description</h5>
            <p class="text-muted" style="white-space: pre-wrap;">{{ book.description|linebreaksbr|default:"No description available." }}</p>

            <h5 class="mt-4">Availability</h5>
            <p>
                {% if book.available_copies_count > 0 %}
                    <span class="badge bg-success fs-6">{{ book.available_copies_count }} cop{{ book.available_copies_count|pluralize:"y,ies" }} available</span>
                {% else %}
                    <span class="badge bg-danger fs-6">Currently unavailable</span>
                {% endif %}
                <small class="text-muted ms-2">({{ book.copies.count }} total physical cop{{ book.copies.count|pluralize:"y,ies"}} in library)</small>
            </p>

            {# List individual copies if desired #}
            {#
            <h5 class="mt-4">Copies in Library ({{ book.copies.count }})</h5>
            {% if book.copies.all %}
            <ul class="list-group list-group-flush">
                {% for copy in book.copies.all %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Copy ID: {{ copy.copy_id }}
                    <span class="badge {% if copy.status == 'Available' %}bg-success{% elif copy.status == 'On Loan' %}bg-warning text-dark{% else %}bg-secondary{% endif %} rounded-pill">
                        {{ copy.get_status_display }}
                    </span>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted">No physical copies registered for this title.</p>
            {% endif %}
            #}

        </div>
    </div>
</div>

{% if user.is_authenticated and book.available_copies_count > 0 and not has_active_or_pending_request %}
<div class="modal fade" id="borrowBookModal" tabindex="-1" aria-labelledby="borrowBookModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="#"> {# TODO: This action URL needs to be a 'borrow_request' URL #}
        {% csrf_token %}
        <input type="hidden" name="book_isbn" value="{{ book.isbn }}">
        {# If you allow selecting a specific copy from available ones: #}
        {# <input type="hidden" name="book_copy_id" value="{{ first_available_copy.id }}"> #}

        <div class="modal-header">
          <h5 class="modal-title" id="borrowBookModalLabel">Request to Borrow: {{ book.title }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>You are about to request to borrow this book.</p>
          <div class="mb-3">
            <label for="id_due_date_request" class="form-label">Preferred Due Date:</label>
            <input type="date" name="due_date" id="id_due_date_request" class="form-control" required>
            <small class="form-text text-muted">Select the date you plan to return the book. Standard loan period is typically 2 weeks.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Confirm Borrow Request</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('id_due_date_request');
    if (dateInput) {
        const today = new Date();
        const minDate = new Date(today);
        minDate.setDate(today.getDate() + 1); // Minimum due date is tomorrow

        const defaultDueDate = new Date(today);
        defaultDueDate.setDate(today.getDate() + 14); // Default to 2 weeks

        dateInput.setAttribute('min', minDate.toISOString().split('T')[0]);
        dateInput.value = defaultDueDate.toISOString().split('T')[0]; // Set default value
    }
});
</script>
{% endif %}

{% endblock portal_content %}