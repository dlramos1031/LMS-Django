{% load static %}
{% load bootstrap5 %}

{# This template expects 'book', 'view_context', 'back_url', and conditional flags like #}
{# 'can_edit_this_object', 'can_manage_copies', 'has_active_or_pending_request', etc. to be in the context #}

<div class="row g-4 g-lg-5">
    <div class="col-md-4">
        {% if book.cover_image %}
            <img src="{{ book.cover_image.url }}" class="img-fluid rounded shadow-sm mb-3" alt="{{ book.title }} cover" style="max-height: 500px; width: 100%; object-fit: cover;">
        {% else %}
            <div class="bg-light border rounded d-flex flex-column align-items-center justify-content-center text-muted mb-3" style="height: 400px; border-style: dashed!important;">
                <i class="bi bi-image-alt h1"></i>
                <small>No Cover Available</small>
            </div>
        {% endif %}

        {# --- ACTION BUTTONS --- #}
        {% if user.is_authenticated %}
            {% if view_context == 'portal' and not user.is_staff %} {# Borrower context #}
                {% if has_active_or_pending_request %}
                    <button class="btn btn-secondary w-100 mb-2" disabled><i class="bi bi-clock-history"></i> Request Pending / Loan Active</button>
                {% elif can_borrow_this_book %}
                    <button class="btn btn-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#borrowBookModal"><i class="bi bi-book-half"></i> Request to Borrow</button>
                {% elif can_reserve_this_book %}
                    <form method="post" action="{% url 'books:portal_book_reserve' isbn=book.isbn %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-warning w-100 mb-2"><i class="bi bi-bookmark-plus"></i> Request Reservation</button>
                    </form>
                {% else %}
                     <button class="btn btn-outline-secondary w-100 mb-2" disabled>Not Currently Available</button>
                {% endif %}
                {# Favorite button for borrowers - placeholder #}
                {# <button class="btn btn-outline-danger w-100"><i class="bi bi-heart{% if is_favorite_book %}-fill{% endif %}"></i> {% if is_favorite_book %}Favorited{% else %}Add to Favorites{% endif %}</button> #}
            {% endif %}
        {% elif view_context == 'portal' %} {# Unauthenticated user in portal #}
            <a href="{% url 'users:login' %}?next={{ request.get_full_path|urlencode }}" class="btn btn-outline-primary w-100 mb-2">Login to Borrow or Reserve</a>
        {% endif %}
    </div>

    <div class="col-md-8">
        <h1 class="display-5 mb-1">{{ book.title }}</h1>
         {% if book.authors.all %}
             <p class="lead text-muted mb-3">
                 By
                 {% for author in book.authors.all %}
                     <a href="{% if view_context == 'dashboard' %}{% url 'books:dashboard_author_detail' pk=author.pk %}{% else %}{% url 'books:portal_author_detail' pk=author.pk %}{% endif %}" class="text-decoration-none">{{ author.name }}</a>{% if not forloop.last %}, {% endif %}
                 {% endfor %}
             </p>
         {% endif %}
         <div class="mb-3">
             {% for cat in book.categories.all %}
                 <a href="{% if view_context == 'dashboard' %}{% url 'books:dashboard_category_detail' pk=cat.pk %}{% else %}{% url 'books:portal_category_detail' pk=cat.pk %}{% endif %}" class="badge bg-info text-dark me-1 text-decoration-none">{{ cat.name }}</a>
             {% endfor %}
         </div>
        {# ... Other book details: ISBN, Publisher, Edition, Pages, Description, Availability ... #}
        <p class="mb-2"><strong>ISBN-13:</strong> {{ book.isbn }}</p>
        {% if book.publisher %}<p class="mb-2"><strong>Publisher:</strong> {{ book.publisher }}{% if book.publication_date %}, {{ book.publication_date|date:"Y" }}{% endif %}</p>{% endif %}
        {% if book.edition %}<p class="mb-2"><strong>Edition:</strong> {{ book.edition }}</p>{% endif %}
        {% if book.page_count %}<p class="mb-2"><strong>Pages:</strong> {{ book.page_count }}</p>{% endif %}
        
        <h5 class="mt-4">Description</h5>
        <p class="text-muted" style="white-space: pre-wrap;">{{ book.description|linebreaksbr|default:"No description available." }}</p>

        <h5 class="mt-4">Availability</h5>
        <p>
            {% if book.available_copies_count > 0 %}
                <span class="badge bg-success fs-6">{{ book.available_copies_count }} cop{{ book.available_copies_count|pluralize:"y,ies" }} available</span>
            {% else %}
                <span class="badge bg-danger fs-6">Currently unavailable</span>
            {% endif %}
            <small class="text-muted ms-2">({{ book.copies.count }} total physical cop{{ book.copies.count|pluralize:"y,ies"}} in library)</small>
        </p>

        {% if view_context == 'dashboard' %}
            {# Dashboard specific sections like list of all copies and active loans for this book #}
            <h5 class="mt-4">Copies in Library ({{ all_book_copies.count }})</h5>
            {% if all_book_copies %}
            <div class="table-responsive" style="max-height: 200px;">
                <table class="table table-sm table-striped">
                    <thead><tr><th>Copy ID</th><th>Status</th><th>Acquired</th></tr></thead>
                    <tbody>
                    {% for copy in all_book_copies %}
                    <tr>
                        <td>{{copy.copy_id}}</td>
                        <td><span class="badge bg-{% if copy.status == 'Available' %}success{% elif copy.status == 'On Loan'%}warning text-dark{% else %}secondary{% endif %}">{{ copy.get_status_display }}</span></td>
                        <td>{{copy.date_acquired|date:"Y-m-d"|default:"N/A"}}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No physical copies registered for this title.</p>
            {% endif %}

            <h5 class="mt-4">Active Loans for this Book Title ({{ active_loans_for_this_book.count }})</h5>
            {% if active_loans_for_this_book %}
             <div class="table-responsive" style="max-height: 200px;">
                <table class="table table-sm table-striped">
                    <thead><tr><th>Copy ID</th><th>Borrower</th><th>Due Date</th></tr></thead>
                    <tbody>
                    {% for loan in active_loans_for_this_book %}
                    <tr>
                        <td>{{loan.book_copy.copy_id}}</td>
                        <td><a href="{% url 'users:dashboard_user_detail' pk=loan.borrower.pk %}">{{loan.borrower.username}}</a></td>
                        <td>{{loan.due_date|date:"Y-m-d"}}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">No active loans for this book title.</p>
            {% endif %}
        {% endif %} {# End of dashboard specific sections #}
    </div>
</div>

{% if view_context == 'portal' and user.is_authenticated and not user.is_staff and can_borrow_this_book %}
    {# ... Your existing borrowBookModal HTML ... #}
    <div class="modal fade" id="borrowBookModal" tabindex="-1" aria-labelledby="borrowBookModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="post" action="{% url 'books:portal_catalog' %}"> {# URL for borrow request #}
            {% csrf_token %}
            <input type="hidden" name="book_isbn" value="{{ book.isbn }}">
            <div class="modal-header">
              <h5 class="modal-title" id="borrowBookModalLabel">Request to Borrow: {{ book.title }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p>You are requesting to borrow "{{ book.title }}".</p>
              <div class="mb-3">
                <label for="id_due_date_request" class="form-label">Preferred Due Date:</label>
                <input type="date" name="due_date" id="id_due_date_request" class="form-control" required>
                <small class="form-text text-muted">Standard loan period is typically 2 weeks.</small>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Confirm Borrow Request</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const dateInputModal = document.getElementById('id_due_date_request');
        if (dateInputModal) { /* ... your datepicker script ... */ }
    });
    </script>
{% endif %}