{% extends "dashboard/dashboard_base.html" %}
{% load static %}
{% load bootstrap5 %}

{% block dashboard_title %}
  {% if active_dashboard_tab == 'pending' %}Pending Requests
  {% elif active_dashboard_tab == 'active' %}Currently Borrowed
  {% elif active_dashboard_tab == 'history' %}Borrow History
  {% elif active_dashboard_tab == 'books' %}Manage Books
  {% elif active_dashboard_tab == 'users' %}Manage Users
  {% else %}Overview{% endif %}
{% endblock dashboard_title %}

<div class="container-fluid mt-3">

  <h2 class="mb-3">Librarian Dashboard</h2>

  {# Content Area - Display based on active_tab #}

  
  {% block dashboard_content %}

    {# ==================== PENDING TAB ==================== #}
    {% if active_tab == 'pending' %}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">Pending Borrow Requests</h5>
        {# Search Form #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="pending"> {# Correct tab value #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search book or user..."
                 value="{{ search_term|default:'' }}"
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
      {# Pending Borrowings Table #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Book</th>
              <th>Requested</th>
              <th>Due Date</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for borrow in pending_page %} {# Use pending_page from context #}
            <tr>
              <td>
                <a href="{% url 'user_profile' borrow.user.id %}">{{ borrow.user.username }}</a>
              </td>
              <td>{{ borrow.book.title }}
                <a href="{% url 'user_profile' borrow.book.id %}">{{ borrow.book.title }}</a>
              </td>
              <td>{{ borrow.borrow_date|date:"Y-m-d H:i" }}</td>
              <td>{{ borrow.due_date|date:"Y-m-d" }}</td>
              <td class="text-center">
                {# Approve Form #}
                <form method="post" action="{% url 'approve_borrow' borrow.id %}" class="d-inline me-1">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-success btn-sm" title="Approve Request">
                     <i class="bi bi-check-lg"></i> Approve
                  </button>
                </form>
                {# Reject Form #}
                <form method="post" action="{% url 'reject_borrow' borrow.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger btn-sm" title="Reject Request">
                     <i class="bi bi-x-lg"></i> Reject
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                {% if search_term %}
                  No pending requests found matching your search.
                {% else %}
                  No pending requests.
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {# Pagination #}
      {% include "books/includes/pagination.html" with page_obj=pending_page %}
    {% endif %} {# End Pending Tab #}


    {# ==================== ACTIVE TAB ==================== #}
    {% if active_tab == 'active' %}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">Currently Borrowed Books</h5>
         {# Search Form #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="active"> {# Correct tab value #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search book or user..."
                 value="{{ search_term|default:'' }}"
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
       {# Active Borrowings Table #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Book</th>
              <th>Borrowed On</th> {# Changed from 'Requested' #}
              <th>Due Date</th>
              <th>Status</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for borrow in active_page %} {# Use active_page from context #}
            <tr>
              <td>{{ borrow.user.username }}</td>
              <td>{{ borrow.book.title }}</td>
              <td>{{ borrow.borrow_date|date:"Y-m-d" }}</td> {# Assuming borrow_date is approval/start date #}
              <td>{{ borrow.due_date|date:"Y-m-d" }}</td>
              <td>
                {# Use the model property for overdue status #}
                {% if borrow.is_overdue %}
                  <span class="badge bg-danger">Overdue</span>
                {% else %}
                  <span class="badge bg-success">On Time</span>
                {% endif %}
              </td>
              <td class="text-center">
                 {# Mark Returned Form #}
                <form method="post" action="{% url 'mark_returned' borrow.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-primary btn-sm" title="Mark as Returned">
                    <i class="bi bi-check2-square"></i> Mark Returned
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                 {% if search_term %}
                  No active borrowings found matching your search.
                 {% else %}
                  No books currently borrowed.
                 {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {# Pagination #}
      {% include "books/includes/pagination.html" with page_obj=active_page %}
    {% endif %} {# End Active Tab #}


    {# ==================== HISTORY TAB ==================== #}
    {% if active_tab == 'history' %}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">Borrowing History (Returned/Rejected)</h5>
         {# Search Form #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="history"> {# Correct tab value #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search book or user..."
                 value="{{ search_term|default:'' }}"
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
      {# History Table #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Book</th>
              <th>Requested On</th> {# Changed label #}
              <th>Due Date</th>
              <th>Status</th>
              <th>Returned/Closed On</th> {# Changed label #}
            </tr>
          </thead>
          <tbody>
            {% for borrow in history_page %} {# Use history_page from context #}
            <tr>
              <td>
                <a href="{% url 'user_profile' borrow.user.id %}">{{ borrow.user.username }}</a>
              </td>
              <td>
                <a href="{% url 'book_detail' borrow.book.id %}">{{ borrow.book.title }}</a>
              </td>
              <td>{{ borrow.borrow_date|date:"Y-m-d" }}</td>
              <td>{{ borrow.due_date|date:"Y-m-d"|default:"N/A" }}</td> {# Due date might be null for rejected #}
              <td>
                  {# Display final status #}
                  <span class="badge {% if borrow.status == 'returned' %}bg-secondary{% elif borrow.status == 'rejected' %}bg-warning text-dark{% else %}bg-light text-dark{% endif %}">
                      {{ borrow.get_status_display }} {# Use display value #}
                  </span>
              </td>
              <td>
                  {# Show actual return date if returned, otherwise maybe rejection date if available #}
                  {{ borrow.actual_return_date|date:"Y-m-d H:i"|default:"-" }}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                 {% if search_term %}
                  No history found matching your search.
                 {% else %}
                  No borrowing history.
                 {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {# Pagination #}
      {% include "books/includes/pagination.html" with page_obj=history_page %}
    {% endif %} {# End History Tab #}


    {# ==================== BOOKS TAB ==================== #}
    {% if active_tab == 'books' %}
      {# This uses the enhanced snippet provided previously #}
      {# Header and Search for Books Tab #}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">Books Catalog</h5>
        {# Search Form specific to books tab #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="books"> {# Keep track of the current tab #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search title, author, genre..."
                 value="{{ search_term|default:'' }}" {# Use search_term from context #}
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search {# Example using Bootstrap Icons #}
          </button>
        </form>
      </div>

      {# Books Table - Added more columns #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Authors</th>
              <th>ISBN-13</th> 
              <th>Published</th> 
              <th>Quantity</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for book in book_page %} 
            <tr>
              <td>
                  {% if book.cover_image %}
                     <img src="{{ book.cover_image.url }}" alt="" width="30" height="45" class="me-2 rounded object-fit-cover">
                  {% else %}
                     <span class="d-inline-block bg-light border me-2" style="width: 30px; height: 45px; vertical-align: middle;"></span>
                  {% endif %}
                  <a href="{% url 'book_detail' book.id %}">{{ book.title }}</a>
              </td>
              <td>
                {# Display authors concisely #}
                {{ book.authors.all|join:", " }}
              </td>
               <td>{{ book.isbn_13|default:"N/A" }}</td> {# Display ISBN-13 #}
               <td>{{ book.publish_date|date:"Y-m-d"|default:"N/A" }}</td> {# Display Publish Date #}
              <td>{{ book.quantity }}</td>
              <td class="text-center">
                {# Action Buttons triggering modals #}
                <button class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="modal" data-bs-target="#editBookModal-{{ book.id }}" title="Edit {{ book.title }}">
                    <i class="bi bi-pencil-square"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteBookModal-{{ book.id }}" title="Delete {{ book.title }}">
                    <i class="bi bi-trash"></i> Delete
                </button>

                {# Edit Book Modal #}
                {% include 'books/includes/dashboard/_edit_book_modal.html' with book=book %}

                {# Delete Book Modal (Unique ID per book) #}
                {% include 'books/includes/dashboard/_delete_book_modal.html' with book=book %}
                
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                {% if search_term %}
                  No books found matching your search criteria.
                {% else %}
                  No books in the catalog yet. Add one below!
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div> {# End .table-responsive #}

      {# Add Book Button #}
      <div class="text-end mb-4">
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addBookModal">
          <i class="bi bi-plus-circle"></i> Add New Book
        </button>
      </div>

      {# Add Book Modal #}
      {% include 'books/includes/dashboard/_add_book_modal.html' %}

      {# Pagination Controls #}
      {% include "books/includes/pagination.html" with page_obj=book_page %}
    {% endif %} {# End Books Tab #}


    {# ==================== USERS TAB ==================== #}
    {% if active_tab == 'users' %}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">User Accounts</h5>
        {# Search Form #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="users"> {# Correct tab value #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search username, name, email..."
                 value="{{ search_term|default:'' }}"
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
      {# Users Table #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Username</th>
              <th>Full Name</th>
              <th>Email</th>
              <th>Role</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user_obj in user_page %} {# Use user_page from context, renamed to avoid conflict #}
            <tr>
              <td>
                <a href="{% url 'user_profile' user_obj.id %}">{{ user_obj.username }}</a>
              </td>
              <td>{{ user_obj.full_name|default:"-" }}</td> {# Assuming full_name exists #}
              <td>{{ user_obj.email|default:"-" }}</td>
              <td>{{ user_obj.role|capfirst|default:"Member" }}</td> {# Assuming role attribute exists #}
              <td class="text-center">
                {# Logic to determine if actions are allowed #}
                {% if user_obj != request.user and request.user.role == 'admin' %}
                  {# Admins can edit anyone, Librarians can edit non-staff #}
                   <button class="btn btn-sm btn-outline-secondary me-1"
                          data-bs-toggle="modal"
                          data-bs-target="#editUserModal-{{ user_obj.id }}"
                          title="Edit {{ user_obj.username }}">
                      <i class="bi bi-person-gear"></i> Edit
                  </button>
                  {# Prevent deleting self or superusers if not superuser #}
                  {% if user_obj != request.user and not user_obj.is_superuser %}
                    <button class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteUserModal-{{ user_obj.id }}"
                            title="Delete {{ user_obj.username }}">
                        <i class="bi bi-person-x"></i> Delete
                    </button>
                  {% elif user_obj == request.user %}
                     <span class="text-muted fst-italic small">(Your Account)</span>
                  {% endif %}
                {% elif user_obj == request.user %}
                     <span class="text-muted fst-italic small">(Your Account)</span>
                {% else %}
                  <span class="text-muted fst-italic small">No Actions</span>
                {% endif %}

                {# Edit User Modal (Unique ID per user) #}
                {% include 'books/includes/dashboard/_edit_user_modal.html' with user_obj=user_obj %}

                {# Delete User Modal (Unique ID per user) #}
                {% include 'books/includes/dashboard/_delete_user_modal.html' with user_obj=user_obj %}
                
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                 {% if search_term %}
                  No users found matching your search.
                 {% else %}
                  No users found.
                 {% endif %}
                </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div> {# End .table-responsive #}

      {# Add User Button - Conditionally show based on permissions #}
      {% if request.user.is_superuser %} {# Example: Only superusers can add users #}
      <div class="text-end mb-4">
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
          <i class="bi bi-person-plus"></i> Add New User
        </button>
      </div>
      {% endif %}

      {# Add User Modal #}
      {% include 'books/includes/dashboard/_add_user_modal.html' %}

      {# Pagination #}
      {% include "books/includes/pagination.html" with page_obj=user_page %}
    {% endif %} {# End Users Tab #}

{% endblock dashboard_content %}
</div> {# End .container-fluid #}
