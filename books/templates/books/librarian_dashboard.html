{% extends "base.html" %}
{% block title %}Librarian Dashboard{% endblock %}
{% block content %}

<h2>Librarian Dashboard</h2>

<ul class="nav nav-tabs mb-3">
  <li class="nav-item">
    <a class="nav-link {% if tab == 'pending' %}active{% endif %}" href="?tab=pending">Pending Requests</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if tab == 'active' %}active{% endif %}" href="?tab=active">Currently Borrowed</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if tab == 'history' %}active{% endif %}" href="?tab=history">Borrow History</a>
  </li>
</ul>

{% if tab == 'pending' %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Pending Borrow Requests</h5>
  <form method="get" class="d-flex" style="gap: 0.5rem;">
    <input type="hidden" name="tab" value="TAB_NAME">
    <input type="text" name="search" class="form-control form-control-sm"
           placeholder="Search..." value="{{ request.GET.search }}" style="width: 200px;">
    <button class="btn btn-sm btn-outline-primary" type="submit">Search</button>
  </form>
</div>
<table class="table table-sm table-bordered">
  <thead>
    <tr><th>User</th><th>Book</th><th>Return Date</th><th>Requested</th><th>Actions</th></tr>
  </thead>
  <tbody>
    {% for borrow in pending_page %}
    <tr>
      <td>{{ borrow.user.username }}</td>
      <td>{{ borrow.book.title }}</td>
      <td>{{ borrow.return_date|date:"Y-m-d" }}</td>
      <td>{{ borrow.borrow_date|date:"Y-m-d H:i" }}</td>
      <td>
        <form method="post" action="{% url 'approve_borrow' borrow.id %}" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-success btn-sm">Approve</button>
        </form>
        <form method="post" action="{% url 'reject_borrow' borrow.id %}" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-danger btn-sm">Reject</button>
        </form>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="5">No pending requests.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% include "books/includes/pagination.html" with page_obj=pending_page %}

{% elif tab == 'active' %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Currently Borrowed Books</h5>
  <form method="get" class="d-flex" style="gap: 0.5rem;">
    <input type="hidden" name="tab" value="TAB_NAME">
    <input type="text" name="search" class="form-control form-control-sm"
           placeholder="Search..." value="{{ request.GET.search }}" style="width: 200px;">
    <button class="btn btn-sm btn-outline-primary" type="submit">Search</button>
  </form>
</div>
<table class="table table-sm table-bordered">
  <thead>
    <tr><th>User</th><th>Book</th><th>Borrowed</th><th>Return Due</th><th>Status</th><th>Action</th></tr>
  </thead>
  <tbody>
    {% for borrow in active_page %}
    <tr>
      <td>{{ borrow.user.username }}</td>
      <td>{{ borrow.book.title }}</td>
      <td>{{ borrow.borrow_date|date:"Y-m-d" }}</td>
      <td>{{ borrow.return_date|date:"Y-m-d" }}</td>
      <td>
        {% if borrow.return_date < now %}
        <span class="badge bg-danger">Overdue</span>
        {% else %}
        <span class="badge bg-success">On time</span>
        {% endif %}
      </td>
      <td>
        <form method="post" action="{% url 'mark_returned' borrow.id %}">
          {% csrf_token %}
          <button class="btn btn-primary btn-sm">Mark Returned</button>
        </form>
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6">No active borrowings.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% include "books/includes/pagination.html" with page_obj=active_page %}

{% elif tab == 'history' %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h5 class="mb-0">Completed Borrow History</h5>
  <form method="get" class="d-flex" style="gap: 0.5rem;">
    <input type="hidden" name="tab" value="TAB_NAME">
    <input type="text" name="search" class="form-control form-control-sm"
           placeholder="Search..." value="{{ request.GET.search }}" style="width: 200px;">
    <button class="btn btn-sm btn-outline-primary" type="submit">Search</button>
  </form>
</div>

<table class="table table-sm table-bordered">
  <thead>
    <tr><th>User</th><th>Book</th><th>Borrowed</th><th>Returned</th></tr>
  </thead>
  <tbody>
    {% for borrow in history_page %}
    <tr>
      <td>{{ borrow.user.username }}</td>
      <td>{{ borrow.book.title }}</td>
      <td>{{ borrow.borrow_date|date:"Y-m-d" }}</td>
      <td>{{ borrow.return_date|date:"Y-m-d" }}</td>
    </tr>
    {% empty %}
    <tr><td colspan="4">No completed borrows.</td></tr>
    {% endfor %}
  </tbody>
</table>
{% include "books/includes/pagination.html" with page_obj=history_page %}
{% endif %}

{% endblock %}
