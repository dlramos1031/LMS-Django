{% extends "base.html" %}
{% load static %}
{% block title %}Librarian Dashboard{% endblock %}
{% block content %}
<div class="container-fluid mt-3">

  <h2 class="mb-3">Librarian Dashboard</h2>

  {# Main Navigation Tabs #}
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link {% if active_tab == 'pending' %}active{% endif %}" href="{% url 'librarian_dashboard' %}?tab=pending">Pending Requests</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if active_tab == 'active' %}active{% endif %}" href="{% url 'librarian_dashboard' %}?tab=active">Currently Borrowed</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if active_tab == 'history' %}active{% endif %}" href="{% url 'librarian_dashboard' %}?tab=history">Borrow History</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if active_tab == 'books' %}active{% endif %}" href="{% url 'librarian_dashboard' %}?tab=books">Manage Books</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if active_tab == 'users' %}active{% endif %}" href="{% url 'librarian_dashboard' %}?tab=users">Manage Users</a>
    </li>
  </ul>

  {# Content Area - Display based on active_tab #}
  <div class="tab-content">

    {# ==================== PENDING TAB ==================== #}
    {% if active_tab == 'pending' %}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">Pending Borrow Requests</h5>
        {# Search Form #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="pending"> {# Correct tab value #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search book or user..."
                 value="{{ search_term|default:'' }}"
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
      {# Pending Borrowings Table #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Book</th>
              <th>Requested</th>
              <th>Due Date</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for borrow in pending_page %} {# Use pending_page from context #}
            <tr>
              <td>{{ borrow.user.username }}</td>
              <td>{{ borrow.book.title }}</td>
              <td>{{ borrow.borrow_date|date:"Y-m-d H:i" }}</td>
              <td>{{ borrow.due_date|date:"Y-m-d" }}</td>
              <td class="text-center">
                {# Approve Form #}
                <form method="post" action="{% url 'approve_borrow' borrow.id %}" class="d-inline me-1">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-success btn-sm" title="Approve Request">
                     <i class="bi bi-check-lg"></i> Approve
                  </button>
                </form>
                {# Reject Form #}
                <form method="post" action="{% url 'reject_borrow' borrow.id %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-danger btn-sm" title="Reject Request">
                     <i class="bi bi-x-lg"></i> Reject
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                {% if search_term %}
                  No pending requests found matching your search.
                {% else %}
                  No pending requests.
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {# Pagination #}
      {% include "books/includes/pagination.html" with page_obj=pending_page %}
    {% endif %} {# End Pending Tab #}


    {# ==================== ACTIVE TAB ==================== #}
    {% if active_tab == 'active' %}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">Currently Borrowed Books</h5>
         {# Search Form #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="active"> {# Correct tab value #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search book or user..."
                 value="{{ search_term|default:'' }}"
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
       {# Active Borrowings Table #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Book</th>
              <th>Borrowed On</th> {# Changed from 'Requested' #}
              <th>Due Date</th>
              <th>Status</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for borrow in active_page %} {# Use active_page from context #}
            <tr>
              <td>{{ borrow.user.username }}</td>
              <td>{{ borrow.book.title }}</td>
              <td>{{ borrow.borrow_date|date:"Y-m-d" }}</td> {# Assuming borrow_date is approval/start date #}
              <td>{{ borrow.due_date|date:"Y-m-d" }}</td>
              <td>
                {# Use the model property for overdue status #}
                {% if borrow.is_overdue %}
                  <span class="badge bg-danger">Overdue</span>
                {% else %}
                  <span class="badge bg-success">On Time</span>
                {% endif %}
              </td>
              <td class="text-center">
                 {# Mark Returned Form #}
                <form method="post" action="{% url 'mark_returned' borrow.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-primary btn-sm" title="Mark as Returned">
                    <i class="bi bi-check2-square"></i> Mark Returned
                  </button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                 {% if search_term %}
                  No active borrowings found matching your search.
                 {% else %}
                  No books currently borrowed.
                 {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {# Pagination #}
      {% include "books/includes/pagination.html" with page_obj=active_page %}
    {% endif %} {# End Active Tab #}


    {# ==================== HISTORY TAB ==================== #}
    {% if active_tab == 'history' %}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">Borrowing History (Returned/Rejected)</h5>
         {# Search Form #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="history"> {# Correct tab value #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search book or user..."
                 value="{{ search_term|default:'' }}"
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
      {# History Table #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>User</th>
              <th>Book</th>
              <th>Requested On</th> {# Changed label #}
              <th>Due Date</th>
              <th>Status</th>
              <th>Returned/Closed On</th> {# Changed label #}
            </tr>
          </thead>
          <tbody>
            {% for borrow in history_page %} {# Use history_page from context #}
            <tr>
              <td>{{ borrow.user.username }}</td>
              <td>{{ borrow.book.title }}</td>
              <td>{{ borrow.borrow_date|date:"Y-m-d" }}</td>
              <td>{{ borrow.due_date|date:"Y-m-d"|default:"N/A" }}</td> {# Due date might be null for rejected #}
              <td>
                  {# Display final status #}
                  <span class="badge {% if borrow.status == 'returned' %}bg-secondary{% elif borrow.status == 'rejected' %}bg-warning text-dark{% else %}bg-light text-dark{% endif %}">
                      {{ borrow.get_status_display }} {# Use display value #}
                  </span>
              </td>
              <td>
                  {# Show actual return date if returned, otherwise maybe rejection date if available #}
                  {{ borrow.actual_return_date|date:"Y-m-d H:i"|default:"-" }}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                 {% if search_term %}
                  No history found matching your search.
                 {% else %}
                  No borrowing history.
                 {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {# Pagination #}
      {% include "books/includes/pagination.html" with page_obj=history_page %}
    {% endif %} {# End History Tab #}


    {# ==================== BOOKS TAB ==================== #}
    {% if active_tab == 'books' %}
      {# This uses the enhanced snippet provided previously #}
      {# Header and Search for Books Tab #}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">Books Catalog</h5>
        {# Search Form specific to books tab #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="books"> {# Keep track of the current tab #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search title, author, genre..."
                 value="{{ search_term|default:'' }}" {# Use search_term from context #}
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search {# Example using Bootstrap Icons #}
          </button>
        </form>
      </div>

      {# Books Table - Added more columns #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th>Authors</th>
              <th>ISBN-13</th> {# Added ISBN #}
              <th>Published</th> {# Added Publish Date #}
              <th>Quantity</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for book in book_page %} {# Use book_page from context #}
            <tr>
              <td>
                  {% if book.cover_image %}
                     <img src="{{ book.cover_image.url }}" alt="" width="30" height="45" class="me-2 rounded object-fit-cover">
                  {% else %}
                     <span class="d-inline-block bg-light border me-2" style="width: 30px; height: 45px; vertical-align: middle;"></span>
                  {% endif %}
                  {{ book.title }}
              </td>
              <td>
                {# Display authors concisely #}
                {{ book.authors.all|join:", " }}
              </td>
               <td>{{ book.isbn_13|default:"N/A" }}</td> {# Display ISBN-13 #}
               <td>{{ book.publish_date|date:"Y-m-d"|default:"N/A" }}</td> {# Display Publish Date #}
              <td>{{ book.quantity }}</td>
              <td class="text-center">
                {# Action Buttons triggering modals #}
                <button class="btn btn-sm btn-outline-secondary me-1" data-bs-toggle="modal" data-bs-target="#editBookModal-{{ book.id }}" title="Edit {{ book.title }}">
                    <i class="bi bi-pencil-square"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteBookModal-{{ book.id }}" title="Delete {{ book.title }}">
                    <i class="bi bi-trash"></i> Delete
                </button>

                {# Edit Book Modal #}
                <div class="modal fade" id="editBookModal-{{ book.id }}" tabindex="-1" aria-labelledby="editBookModalLabel-{{ book.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-lg modal-dialog-scrollable"> {# Added scrollable #}
                    <div class="modal-content">
                      <form method="post" action="{% url 'edit_book' book.id %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title" id="editBookModalLabel-{{ book.id }}">Edit: {{ book.title }}</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          <div class="row g-3">
                            {# Row 1 #}
                            <div class="col-md-8">
                              <label for="edit-title-{{ book.id }}" class="form-label">Title</label>
                              <input type="text" name="title" id="edit-title-{{ book.id }}" class="form-control form-control-sm" value="{{ book.title }}" required>
                            </div>
                            <div class="col-md-4">
                              <label for="edit-quantity-{{ book.id }}" class="form-label">Quantity</label>
                              <input type="number" name="quantity" id="edit-quantity-{{ book.id }}" class="form-control form-control-sm" value="{{ book.quantity }}" min="0" required>
                            </div>

                            {# Row 2 #}
                            <div class="col-md-6">
                              <label for="edit-authors-{{ book.id }}" class="form-label">Authors (comma-separated)</label>
                              <input type="text" name="authors" id="edit-authors-{{ book.id }}" class="form-control form-control-sm" value="{{ book.authors.all|join:", " }}">
                            </div>
                            <div class="col-md-6">
                              <label for="edit-genres-{{ book.id }}" class="form-label">Genres (comma-separated)</label>
                              <input type="text" name="genres" id="edit-genres-{{ book.id }}" class="form-control form-control-sm" value="{{ book.genres.all|join:", " }}">
                            </div>

                            {# Row 3 - New Fields #}
                             <div class="col-md-6">
                              <label for="edit-publisher-{{ book.id }}" class="form-label">Publisher</label>
                              <input type="text" name="publisher" id="edit-publisher-{{ book.id }}" class="form-control form-control-sm" value="{{ book.publisher|default_if_none:'' }}">
                            </div>
                             <div class="col-md-6">
                              <label for="edit-publish_date-{{ book.id }}" class="form-label">Publish Date</label>
                              <input type="date" name="publish_date" id="edit-publish_date-{{ book.id }}" class="form-control form-control-sm" value="{{ book.publish_date|date:'Y-m-d'|default:'' }}">
                            </div>

                            {# Row 4 - New Fields #}
                            <div class="col-md-6">
                              <label for="edit-isbn_13-{{ book.id }}" class="form-label">ISBN-13</label>
                              <input type="text" name="isbn_13" id="edit-isbn_13-{{ book.id }}" class="form-control form-control-sm" value="{{ book.isbn_13|default_if_none:'' }}">
                            </div>
                            <div class="col-md-6">
                              <label for="edit-isbn_10-{{ book.id }}" class="form-label">ISBN-10</label>
                              <input type="text" name="isbn_10" id="edit-isbn_10-{{ book.id }}" class="form-control form-control-sm" value="{{ book.isbn_10|default_if_none:'' }}">
                            </div>

                            {# Row 5 - New Fields #}
                             <div class="col-md-6">
                              <label for="edit-language-{{ book.id }}" class="form-label">Language</label>
                              <input type="text" name="language" id="edit-language-{{ book.id }}" class="form-control form-control-sm" value="{{ book.language|default_if_none:'' }}">
                            </div>
                             <div class="col-md-6">
                              <label for="edit-page_count-{{ book.id }}" class="form-label">Page Count</label>
                              <input type="number" name="page_count" id="edit-page_count-{{ book.id }}" class="form-control form-control-sm" value="{{ book.page_count|default_if_none:'' }}" min="1">
                            </div>

                             {# Row 6 - Existing Fields #}
                             <div class="col-md-6">
                              <label for="edit-open_library_id-{{ book.id }}" class="form-label">Open Library ID</label>
                              <input type="text" name="open_library_id" id="edit-open_library_id-{{ book.id }}" class="form-control form-control-sm" value="{{ book.open_library_id|default_if_none:'' }}">
                            </div>
                             <div class="col-md-6">
                                <label for="edit-cover_image-{{ book.id }}" class="form-label">Cover Image</label>
                                {% if book.cover_image %}
                                  <div class="mb-1">
                                    <img src="{{ book.cover_image.url }}" class="img-thumbnail" style="max-height: 60px;" alt="Current Cover">
                                    <div class="form-check form-check-inline ms-2">
                                        {# Add a way to clear the image if needed by the view #}
                                        {# <input class="form-check-input" type="checkbox" name="clear_cover_image" id="clear_cover_image-{{ book.id }}">
                                        <label class="form-check-label" for="clear_cover_image-{{ book.id }}">Remove</label> #}
                                    </div>
                                  </div>
                                {% endif %}
                                <input type="file" name="cover_image" id="edit-cover_image-{{ book.id }}" class="form-control form-control-sm">
                                <small class="form-text text-muted">Upload new image to replace current one.</small>
                             </div>

                            {# Row 7 - Summary #}
                            <div class="col-12">
                              <label for="edit-summary-{{ book.id }}" class="form-label">Summary</label>
                              <textarea name="summary" id="edit-summary-{{ book.id }}" class="form-control form-control-sm" rows="4">{{ book.summary|default_if_none:'' }}</textarea>
                            </div>

                          </div> {# End .row #}
                        </div> {# End .modal-body #}
                        <div class="modal-footer">
                          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-sm btn-primary">Save Changes</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>{# End Edit Modal #}

                {# Delete Book Modal (Unique ID per book) #}
                <div class="modal fade" id="deleteBookModal-{{ book.id }}" tabindex="-1" aria-labelledby="deleteBookModalLabel-{{ book.id }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <form method="post" action="{% url 'delete_book' book.id %}">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title" id="deleteBookModalLabel-{{ book.id }}">Confirm Delete</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to permanently delete the book: <strong>{{ book.title }}</strong>?
                          <br><small class="text-danger">This action cannot be undone.</small>
                        </div>
                        <div class="modal-footer">
                           <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-sm btn-danger">Delete Book</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>{# End Delete Modal #}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center text-muted">
                {% if search_term %}
                  No books found matching your search criteria.
                {% else %}
                  No books in the catalog yet. Add one below!
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div> {# End .table-responsive #}

      {# Add Book Button #}
      <div class="text-end mb-4">
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addBookModal">
          <i class="bi bi-plus-circle"></i> Add New Book
        </button>
      </div>

      {# Add Book Modal - Includes New Fields #}
      <div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable"> {# Added scrollable #}
          <div class="modal-content">
            <form method="post" action="{% url 'add_book' %}" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="addBookModalLabel">Add New Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row g-3">
                    {# Row 1 #}
                    <div class="col-md-8">
                        <label for="add-title" class="form-label">Title</label>
                        <input type="text" name="title" id="add-title" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-4">
                        <label for="add-quantity" class="form-label">Quantity</label>
                        <input type="number" name="quantity" id="add-quantity" class="form-control form-control-sm" min="0" value="1" required>
                    </div>

                    {# Row 2 #}
                    <div class="col-md-6">
                        <label for="add-authors" class="form-label">Authors (comma-separated)</label>
                        <input type="text" name="authors" id="add-authors" class="form-control form-control-sm">
                        <small class="form-text text-muted">e.g., Jane Austen, George Orwell</small>
                    </div>
                    <div class="col-md-6">
                        <label for="add-genres" class="form-label">Genres (comma-separated)</label>
                        <input type="text" name="genres" id="add-genres" class="form-control form-control-sm">
                         <small class="form-text text-muted">e.g., Fiction, Romance</small>
                    </div>

                    {# Row 3 - New Fields #}
                    <div class="col-md-6">
                        <label for="add-publisher" class="form-label">Publisher</label>
                        <input type="text" name="publisher" id="add-publisher" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-6">
                        <label for="add-publish_date" class="form-label">Publish Date</label>
                        <input type="date" name="publish_date" id="add-publish_date" class="form-control form-control-sm">
                    </div>

                    {# Row 4 - New Fields #}
                    <div class="col-md-6">
                        <label for="add-isbn_13" class="form-label">ISBN-13</label>
                        <input type="text" name="isbn_13" id="add-isbn_13" class="form-control form-control-sm" placeholder="e.g., 978-xxxxxxxxxx">
                    </div>
                    <div class="col-md-6">
                        <label for="add-isbn_10" class="form-label">ISBN-10</label>
                        <input type="text" name="isbn_10" id="add-isbn_10" class="form-control form-control-sm" placeholder="e.g., xxxxxxxxxx">
                    </div>

                    {# Row 5 - New Fields #}
                    <div class="col-md-6">
                        <label for="add-language" class="form-label">Language</label>
                        <input type="text" name="language" id="add-language" class="form-control form-control-sm" placeholder="e.g., English">
                    </div>
                    <div class="col-md-6">
                        <label for="add-page_count" class="form-label">Page Count</label>
                        <input type="number" name="page_count" id="add-page_count" class="form-control form-control-sm" min="1">
                    </div>

                    {# Row 6 - Existing Fields #}
                    <div class="col-md-6">
                        <label for="add-open_library_id" class="form-label">Open Library ID</label>
                        <input type="text" name="open_library_id" id="add-open_library_id" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-6">
                        <label for="add-cover_image" class="form-label">Cover Image</label>
                        <input type="file" name="cover_image" id="add-cover_image" class="form-control form-control-sm">
                    </div>

                    {# Row 7 - Summary #}
                    <div class="col-12">
                        <label for="add-summary" class="form-label">Summary</label>
                        <textarea name="summary" id="add-summary" class="form-control form-control-sm" rows="4"></textarea>
                    </div>

                </div> {# End .row #}
              </div> {# End .modal-body #}
              <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-sm btn-success">Add Book</button>
              </div>
            </form>
          </div>
        </div>
      </div>{# End Add Book Modal #}

      {# Pagination Controls #}
      {% include "books/includes/pagination.html" with page_obj=book_page %}
    {% endif %} {# End Books Tab #}


    {# ==================== USERS TAB ==================== #}
    {% if active_tab == 'users' %}
      <div class="d-flex justify-content-between align-items-center mb-3 pt-3">
        <h5 class="mb-0 text-secondary">User Accounts</h5>
        {# Search Form #}
        <form method="get" class="d-flex" style="gap: 0.5rem;">
          <input type="hidden" name="tab" value="users"> {# Correct tab value #}
          <input type="text" name="search" class="form-control form-control-sm"
                 placeholder="Search username, name, email..."
                 value="{{ search_term|default:'' }}"
                 style="width: 250px;">
          <button class="btn btn-sm btn-outline-primary" type="submit">
            <i class="bi bi-search"></i> Search
          </button>
        </form>
      </div>
      {# Users Table #}
      <div class="table-responsive">
        <table class="table table-sm table-bordered table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Username</th>
              <th>Full Name</th>
              <th>Email</th>
              <th>Role</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user_obj in user_page %} {# Use user_page from context, renamed to avoid conflict #}
            <tr>
              <td>{{ user_obj.username }}</td>
              <td>{{ user_obj.full_name|default:"-" }}</td> {# Assuming full_name exists #}
              <td>{{ user_obj.email|default:"-" }}</td>
              <td>{{ user_obj.role|capfirst|default:"Member" }}</td> {# Assuming role attribute exists #}
              <td class="text-center">
                {# Logic to determine if actions are allowed #}
                {% if user != request.user and request.user.role == 'admin' %}
                  {# Admins can edit anyone, Librarians can edit non-staff #}
                   <button class="btn btn-sm btn-outline-secondary me-1"
                          data-bs-toggle="modal"
                          data-bs-target="#editUserModal-{{ user_obj.id }}"
                          title="Edit {{ user_obj.username }}">
                      <i class="bi bi-person-gear"></i> Edit
                  </button>
                  {# Prevent deleting self or superusers if not superuser #}
                  {% if user_obj != request.user and not user_obj.is_superuser %}
                    <button class="btn btn-sm btn-outline-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#deleteUserModal-{{ user_obj.id }}"
                            title="Delete {{ user_obj.username }}">
                        <i class="bi bi-person-x"></i> Delete
                    </button>
                  {% elif user_obj == request.user %}
                     <span class="text-muted fst-italic small">(Your Account)</span>
                  {% endif %}
                {% elif user_obj == request.user %}
                     <span class="text-muted fst-italic small">(Your Account)</span>
                {% else %}
                  <span class="text-muted fst-italic small">No Actions</span>
                {% endif %}

                {# Edit User Modal (Unique ID per user) #}
                <div class="modal fade" id="editUserModal-{{ user_obj.id }}" tabindex="-1" aria-labelledby="editUserModalLabel-{{ user_obj.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">
                      {# Ensure URL name 'edit_user' exists and takes user_id #}
                      <form method="post" action="{% url 'edit_user' user_obj.id %}">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title" id="editUserModalLabel-{{ user_obj.id }}">Edit User: {{ user_obj.username }}</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          {# Add form fields for user editing based on your User model and form #}
                          <div class="mb-2">
                            <label for="edit-username-{{ user_obj.id }}" class="form-label">Username</label>
                            <input name="username" id="edit-username-{{ user_obj.id }}" class="form-control form-control-sm" value="{{ user_obj.username }}" required>
                          </div>
                          <div class="mb-2">
                            <label for="edit-fullname-{{ user_obj.id }}" class="form-label">Full Name</label>
                            <input name="full_name" id="edit-fullname-{{ user_obj.id }}" class="form-control form-control-sm" value="{{ user_obj.full_name|default:'' }}">
                          </div>
                          <div class="mb-2">
                            <label for="edit-email-{{ user_obj.id }}" class="form-label">Email</label>
                            <input type="email" name="email" id="edit-email-{{ user_obj.id }}" class="form-control form-control-sm" value="{{ user_obj.email|default:'' }}">
                          </div>
                          <div class="mb-2">
                            <label for="edit-password-{{ user_obj.id }}" class="form-label">New Password</label>
                            <input type="password" name="password" id="edit-password-{{ user_obj.id }}" class="form-control form-control-sm" placeholder="(Leave blank to keep current)">
                            <small class="form-text text-muted">Only enter if changing password.</small>
                          </div>
                          {# Role selection - adapt based on your User model's role field/logic #}
                          {% if request.user.is_superuser %} {# Only superusers can change roles? Adjust logic #}
                          <div class="mb-2">
                            <label for="edit-role-{{ user_obj.id }}" class="form-label">Role</label>
                            <select name="role" id="edit-role-{{ user_obj.id }}" class="form-select form-select-sm">
                              <option value="member" {% if user_obj.role == "member" %}selected{% endif %}>Member</option>
                              <option value="librarian" {% if user_obj.role == "librarian" %}selected{% endif %}>Librarian</option>
                              {# Only show admin if editing another admin or allowed by superuser #}
                              {% if user_obj.is_superuser or request.user.is_superuser %}
                                 <option value="admin" {% if user_obj.role == "admin" or user_obj.is_superuser %}selected{% endif %}>Admin</option>
                              {% endif %}
                            </select>
                          </div>
                          {% endif %}
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-sm btn-primary">Save Changes</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>{# End Edit User Modal #}

                {# Delete User Modal (Unique ID per user) #}
                <div class="modal fade" id="deleteUserModal-{{ user_obj.id }}" tabindex="-1" aria-labelledby="deleteUserModalLabel-{{ user_obj.id }}" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                       {# Ensure URL name 'delete_user' exists and takes user_id #}
                      <form method="post" action="{% url 'delete_user' user_obj.id %}">
                        {% csrf_token %}
                        <div class="modal-header">
                          <h5 class="modal-title" id="deleteUserModalLabel-{{ user_obj.id }}">Confirm Delete User</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                          Are you sure you want to permanently delete the user: <strong>{{ user_obj.username }}</strong>?
                           <br><small class="text-danger">All associated borrowing history will remain, but the user account will be removed.</small>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-sm btn-danger">Delete User</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>{# End Delete User Modal #}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center text-muted">
                 {% if search_term %}
                  No users found matching your search.
                 {% else %}
                  No users found.
                 {% endif %}
                </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div> {# End .table-responsive #}

      {# Add User Button - Conditionally show based on permissions #}
      {% if request.user.is_superuser %} {# Example: Only superusers can add users #}
      <div class="text-end mb-4">
        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
          <i class="bi bi-person-plus"></i> Add New User
        </button>
      </div>
      {% endif %}

      {# Add User Modal #}
      <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content">
             {# Ensure URL name 'add_user' exists #}
            <form method="post" action="{% url 'add_user' %}">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                 {# Add form fields for creating a user based on your User model/form #}
                <div class="mb-2">
                  <label for="add-user-username" class="form-label">Username</label>
                  <input name="username" id="add-user-username" class="form-control form-control-sm" required>
                </div>
                <div class="mb-2">
                  <label for="add-user-fullname" class="form-label">Full Name</label>
                  <input name="full_name" id="add-user-fullname" class="form-control form-control-sm">
                </div>
                <div class="mb-2">
                  <label for="add-user-email" class="form-label">Email</label>
                  <input type="email" name="email" id="add-user-email" class="form-control form-control-sm">
                </div>
                <div class="mb-2">
                  <label for="add-user-password" class="form-label">Password</label>
                  <input type="password" name="password" id="add-user-password" class="form-control form-control-sm" required>
                </div>
                 {# Role selection - adapt based on your User model/form #}
                <div class="mb-2">
                  <label for="add-user-role" class="form-label">Role</label>
                  <select name="role" id="add-user-role" class="form-select form-select-sm">
                    <option value="member" selected>Member</option>
                    {% if request.user.is_superuser %} {# Example: Only superusers can create librarians/admins #}
                    <option value="librarian">Librarian</option>
                    {# <option value="admin">Admin</option> #}
                    {% endif %}
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-sm btn-success">Add User</button>
              </div>
            </form>
          </div>
        </div>
      </div>{# End Add User Modal #}

      {# Pagination #}
      {% include "books/includes/pagination.html" with page_obj=user_page %}
    {% endif %} {# End Users Tab #}

  </div> {# End .tab-content #}
</div> {# End .container-fluid #}
{% endblock %}
