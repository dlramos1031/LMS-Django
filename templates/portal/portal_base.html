{% extends "base.html" %} {# It extends your main site-wide base.html #}
{% load static %}
{% load bootstrap5 %}

{% block title %}LMS Portal - {% block portal_title %}{% endblock %}{% endblock %}

{% block site_nav_items %}
    {# Override the site_nav_items from base.html to provide portal-specific navigation #}
    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item">
            <a class="nav-link {% if request.resolver_match.view_name == 'books:portal_catalog' %}active fw-semibold{% endif %}" href="{% url 'books:portal_catalog' %}">
               <i class="bi bi-search me-1"></i>Catalog
            </a>
        </li>
        {% if user.is_authenticated and not user.is_staff %} {# Only show for borrowers #}
        <li class="nav-item">
            <a class="nav-link {% if request.resolver_match.view_name == 'users:my_borrowings' %}active fw-semibold{% endif %}" href="{% url 'users:my_borrowings' %}">
                <i class="bi bi-journal-check me-1"></i>My Borrowings
            </a>
        </li>
        {% endif %}
    </ul>
    <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        {# Copied user authenticated block from base.html, can be an include too #}
        {% if user.is_authenticated %}
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle {% if 'my_profile' in request.resolver_match.view_name or 'edit_my_profile' in request.resolver_match.view_name or 'password_change' in request.resolver_match.view_name %}active fw-semibold{% endif %}" href="#" id="userProfileDropdownPortal" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" alt="{{ user.username }}" class="rounded-circle me-1" style="width: 24px; height: 24px; object-fit: cover;">
                    {% else %}
                        <i class="bi bi-person-circle me-1"></i>
                    {% endif %}
                    {{ user.first_name|default:user.username }}
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userProfileDropdownPortal">
                    {% if user.role == 'BORROWER' and not user.is_staff %} {# Only show profile links relevant to borrower portal context #}
                        <li><a class="dropdown-item {% if request.resolver_match.view_name == 'users:my_profile' %}active{% endif %}" href="{% url 'users:my_profile' %}"><i class="bi bi-person-lines-fill me-2"></i>View Profile</a></li>
                        <li><a class="dropdown-item {% if request.resolver_match.view_name == 'users:edit_my_profile' %}active{% endif %}" href="{% url 'users:edit_my_profile' %}"><i class="bi bi-pencil-square me-2"></i>Edit Profile</a></li>
                        <li><a class="dropdown-item {% if request.resolver_match.view_name == 'users:password_change' %}active{% endif %}" href="{% url 'users:password_change' %}"><i class="bi bi-shield-lock me-2"></i>Change Password</a></li>
                        <li><hr class="dropdown-divider"></li>
                    {% elif user.is_staff %} {# Staff might have a link to their dashboard profile if different #}
                         <li><a class="dropdown-item" href="{% url 'users:my_profile' %}"><i class="bi bi-person-lines-fill me-2"></i>View My Staff Profile</a></li>
                         <li><a class="dropdown-item" href="{% url 'users:password_change' %}"><i class="bi bi-shield-lock me-2"></i>Change Password</a></li>
                         <li><hr class="dropdown-divider"></li>
                         <li><a class="dropdown-item" href="{% url 'books:dashboard_home' %}"><i class="bi bi-speedometer2 me-2"></i>Staff Dashboard</a></li>
                         <li><hr class="dropdown-divider"></li>
                    {% endif %}
                    <li>
                        <form action="{% url 'users:logout' %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="dropdown-item text-danger"><i class="bi bi-box-arrow-right me-2"></i>Logout</button>
                        </form>
                    </li>
                </ul>
            </li>
        {% else %}
             <li class="nav-item">
                <a class="nav-link" href="{% url 'users:login' %}?next={{ request.get_full_path|urlencode }}"><i class="bi bi-box-arrow-in-right me-1"></i>Login</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'users:register' %}"><i class="bi bi-person-plus me-1"></i>Register</a>
            </li>
        {% endif %}
    </ul>
{% endblock site_nav_items %}

{% block main_container_class %}container py-3 mt-5 pt-3{% endblock %} {# Override to adjust padding/margins for portal #}

{% block content_body %} {# This block from base.html will be filled by portal specific content #}
    <div class="portal-main-content"> {# Optional wrapper for portal specific styling #}
        {% bootstrap_messages %}
        {% block portal_content %}
            {# Specific portal page content (catalog.html, book_detail.html, profile.html) will go here #}
        {% endblock portal_content %}
    </div>
{% endblock content_body %}

{% block page_footer %}
    {# Portal can have its own footer or inherit from base.html #}
    {{ block.super }}
{% endblock page_footer %}