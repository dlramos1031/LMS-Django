{% extends "dashboard/dashboard_base.html" %}
{% load static %}
{% load bootstrap5 %}

{% block dashboard_title %}User Accounts{% endblock dashboard_title %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-3 pt-3">
  <h5 class="mb-0 text-secondary">User Accounts</h5>
  {# Search Form #}
  <form method="get" class="d-flex" style="gap: 0.5rem;">
    <input type="hidden" name="tab" value="users"> {# Correct tab value #}
    <input type="text" name="search" class="form-control form-control-sm"
           placeholder="Search username, name, email..."
           value="{{ search_term|default:'' }}"
           style="width: 250px;">
    <button class="btn btn-sm btn-outline-primary" type="submit">
      <i class="bi bi-search"></i> Search
    </button>
  </form>
</div>
{# Users Table #}
<div class="table-responsive">
  <table class="table table-sm table-bordered table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>Username</th>
        <th>Full Name</th>
        <th>Email</th>
        <th>Role</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for user_obj in page_obj %}
      <tr>
        <td>
          <a href="{% url 'user_profile' user_obj.id %}">{{ user_obj.username }}</a>
        </td>
        <td>{{ user_obj.full_name|default:"-" }}</td> {# Assuming full_name exists #}
        <td>{{ user_obj.email|default:"-" }}</td>
        <td>{{ user_obj.role|capfirst|default:"Member" }}</td> {# Assuming role attribute exists #}
        <td class="text-center">
          {# Logic to determine if actions are allowed #}
          {% if user_obj != request.user and request.user.role == 'admin' %}
            {# Admins can edit anyone, Librarians can edit non-staff #}
             <button class="btn btn-sm btn-outline-secondary me-1"
                    data-bs-toggle="modal"
                    data-bs-target="#editUserModal-{{ user_obj.id }}"
                    title="Edit {{ user_obj.username }}">
                <i class="bi bi-person-gear"></i> Edit
            </button>
            {# Prevent deleting self or superusers if not superuser #}
            {% if user_obj != request.user and not user_obj.is_superuser %}
              <button class="btn btn-sm btn-outline-danger"
                      data-bs-toggle="modal"
                      data-bs-target="#deleteUserModal-{{ user_obj.id }}"
                      title="Delete {{ user_obj.username }}">
                  <i class="bi bi-person-x"></i> Delete
              </button>
            {% elif user_obj == request.user %}
               <span class="text-muted fst-italic small">(Your Account)</span>
            {% endif %}
          {% elif user_obj == request.user %}
               <span class="text-muted fst-italic small">(Your Account)</span>
          {% else %}
            <span class="text-muted fst-italic small">No Actions</span>
          {% endif %}

          {# Edit User Modal (Unique ID per user) #}
          {% include 'books/includes/dashboard/_edit_user_modal.html' with user_obj=user_obj %}

          {# Delete User Modal (Unique ID per user) #}
          {% include 'books/includes/dashboard/_delete_user_modal.html' with user_obj=user_obj %}
          
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="text-center text-muted">
           {% if search_term %}
            No users found matching your search.
           {% else %}
            No users found.
           {% endif %}
          </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div> {# End .table-responsive #}

<div class="text-end mb-4">
  <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addUserModal">
    <i class="bi bi-person-plus"></i> Add New User
  </button>
</div>

{# Add User Modal #}
{% block modals %}
  {% include 'books/includes/dashboard/_add_user_modal.html' %}
{% endblock modals %}

{% include "books/includes/pagination.html" with page_obj=user_page %}
{% endblock dashboard_content %}

