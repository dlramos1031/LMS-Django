{% extends "dashboard/dashboard_base.html" %}
{% load static %}
{% load bootstrap5 %}

{% block dashboard_title %}Borrow History{% endblock dashboard_title %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-3 pt-3">
  <h5 class="mb-0 text-secondary">Borrowing History (Returned/Rejected)</h5>
   {# Search Form #}
  <form method="get" class="d-flex" style="gap: 0.5rem;">
    <input type="hidden" name="tab" value="history"> {# Correct tab value #}
    <input type="text" name="search" class="form-control form-control-sm"
           placeholder="Search book or user..."
           value="{{ search_term|default:'' }}"
           style="width: 250px;">
    <button class="btn btn-sm btn-outline-primary" type="submit">
      <i class="bi bi-search"></i> Search
    </button>
  </form>
</div>
{# History Table #}
<div class="table-responsive">
  <table class="table table-sm table-bordered table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>User</th>
        <th>Book</th>
        <th>Requested On</th>
        <th>Due Date</th>
        <th>Returned/Closed On</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for borrow in page_obj %} 
      <tr>
        <td>
          <a href="{% url 'user_profile' borrow.user.id %}">{{ borrow.user.username }}</a>
        </td>
        <td>
          <a href="{% url 'book_detail' borrow.book.id %}">{{ borrow.book.title }}</a>
        </td>
        <td>{{ borrow.borrow_date|date:"Y-m-d" }}</td>
        <td>{{ borrow.due_date|date:"Y-m-d"|default:"N/A" }}</td> {# Due date might be null for rejected #}
        <td>
            {# Show actual return date if returned, otherwise maybe rejection date if available #}
            {{ borrow.actual_return_date|date:"Y-m-d H:i"|default:"-" }}
        </td>
        <td>
          {# Display final status #}
          <span class="badge {% if borrow.status == 'returned' %}bg-secondary{% elif borrow.status == 'rejected' %}bg-warning text-dark{% else %}bg-light text-dark{% endif %}">
              {{ borrow.get_status_display }} {# Use display value #}
          </span>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted">
           {% if search_term %}
            No history found matching your search.
           {% else %}
            No borrowing history.
           {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% include "books/includes/pagination.html" with page_obj=page_obj %}
{% endblock dashboard_content %}