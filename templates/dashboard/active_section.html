{% extends "dashboard/dashboard_base.html" %}
{% load static %}
{% load bootstrap5 %}

{% block dashboard_title %}Currently Borrows{% endblock dashboard_title %}

{% block dashboard_content %}
<div class="d-flex justify-content-between align-items-center mb-3 pt-3">
  <h5 class="mb-0 text-secondary">Currently Borrowed Books</h5>
   {# Search Form #}
  <form method="get" class="d-flex" style="gap: 0.5rem;">
    <input type="hidden" name="tab" value="active"> {# Correct tab value #}
    <input type="text" name="search" class="form-control form-control-sm"
           placeholder="Search book or user..."
           value="{{ search_term|default:'' }}"
           style="width: 250px;">
    <button class="btn btn-sm btn-outline-primary" type="submit">
      <i class="bi bi-search"></i> Search
    </button>
  </form>
</div>
 {# Active Borrowings Table #}
<div class="table-responsive">
  <table class="table table-sm table-bordered table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>User</th>
        <th>Book</th>
        <th>Borrowed On</th> {# Changed from 'Requested' #}
        <th>Due Date</th>
        <th>Status</th>
        <th class="text-center">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for borrow in page_obj %}
      <tr>
        {{ borrow }}
        <td>{{ borrow.user.username }}</td>
        <td>{{ borrow.book.title }}</td>
        <td>{{ borrow.borrow_date|date:"Y-m-d" }}</td>
        <td>{{ borrow.due_date|date:"Y-m-d" }}</td>
        <td>
          {# Use the model property for overdue status #}
          {% if borrow.is_overdue %}
            <span class="badge bg-danger">Overdue</span>
          {% else %}
            <span class="badge bg-success">On Time</span>
          {% endif %}
        </td>
        <td class="text-center">
           {# Mark Returned Form #}
          <form method="post" action="{% url 'mark_returned' borrow.id %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary btn-sm" title="Mark as Returned">
              <i class="bi bi-check2-square"></i> Mark Returned
            </button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted">
           {% if search_term %}
            No active borrowings found matching your search.
           {% else %}
            No books currently borrowed.
           {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% include "books/includes/pagination.html" with page_obj=page_obj %}
{% endblock dashboard_content %}